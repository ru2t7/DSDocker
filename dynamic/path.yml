http:
  routers:
    nginx-frontend:
      rule: "Host(`localhost`)"
      entryPoints:
        - web
      service: frontend-service

    backend-api-device:
      rule: "Host(`localhost`) && PathPrefix(`/api_device`)"
      entryPoints:
        - web
      middlewares:
        - strip-api-prefix-device
      service: api-service-device

    backend-device-swagger:
      # Matches /device/swagger-ui.html, /device/v3/api-docs, etc.
      rule: "Host(`localhost`) && PathPrefix(`/device`)"
      entryPoints:
        - web
      # No middleware here! We want to send the "/device" part to Spring Boot.
      service: api-service-device

    backend-person-swagger:
      # Matches /people/swagger-ui.html, /people/v3/api-docs
      rule: "Host(`localhost`) && PathPrefix(`/people`)"
      entryPoints:
        - web
      service: api-service-person

    backend-api-person:
      rule: "Host(`localhost`) && PathPrefix(`/api_person`)"
      entryPoints:
        - web
      middlewares:
        - strip-api-prefix-person
      service: api-service-person

    backend-api-monitoring:
      rule: "Host(`localhost`) && PathPrefix(`/api_monitoring`)"
      entryPoints:
        - web
      middlewares:
        - strip-api-prefix-monitoring
      service: api-service-monitoring

    backend-monitoring-swagger:
      rule: "Host(`localhost`) && PathPrefix(`/monitoring`)"
      entryPoints:
        - web
      service: api-service-monitoring

    backend-api-communication:
      # This matches the endpoint we defined in WebSocketConfig: /ws-chat
      rule: "Host(`localhost`) && PathPrefix(`/ws-chat`)"
      entryPoints:
        - web
      service: api-service-communication

  middlewares:
    strip-api-prefix-device:
      stripPrefix:
        prefixes:
          - "/api_device"
    strip-api-prefix-person:
      stripPrefix:
        prefixes:
          - "/api_person"
    strip-api-prefix-monitoring:
      stripPrefix:
        prefixes:
          - "/api_monitoring"

  services:
    frontend-service:
      loadBalancer:
        servers:
          - url: "http://frontend:80"

    api-service-device:
      loadBalancer:
        servers:
          - url: "http://container-device:8080"

    api-service-person:
      loadBalancer:
        servers:
          - url: "http://container-person:8081"

    api-service-monitoring:
      loadBalancer:
        servers:
          # Must use the container name and the internal port 8083 (from application.properties)
          - url: "http://container-monitoring:8083"

    api-service-communication:
      loadBalancer:
        servers:
          # Use the container name and the port 8084 we set in application.properties
          - url: "http://container-communication:8084"
