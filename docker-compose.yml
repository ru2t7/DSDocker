version: '3.9'

services:

  # ==========================================
  # DATABASE SERVICES
  # ==========================================

  db_device:
    image: postgres
    container_name: db_device
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: example_db
    ports:
      - "5434:5432" # Access from host via localhost:5434
    volumes:
      - db-device-data:/var/lib/postgresql/data # Persist data even if container dies
    networks:
      proxy-network:

  db_user:
    image: postgres
    container_name: db_user
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: example_db
    ports:
      - "5433:5432" # Access from host via localhost:5433
    volumes:
      - db-user-data:/var/lib/postgresql/data
    networks:
      proxy-network:


  # ==========================================
  # BACKEND API SERVICES
  # ==========================================

  container-device:
    image: image_device
    container_name: container-device
#     Ports are commented out because Traefik handles external access internally
#     ports:
#       - "8080:8080"
    build:
      context: ../../DS/ds2025_spring_example/demo-device
      dockerfile: Dockerfile
    environment:
      - DB_IP=db_device # Must match container_name of the database above
      - DB_PORT=5432    # Internal Postgres port
      - DB_DBNAME=example_db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - PERSON_SERVICE_URL=http://container-person:8081/people
    networks:
      proxy-network:
      
  container-person:
    image: image_person
    container_name: container-person
#     Ports are commented out because Traefik handles external access internally
#    ports:
#      - "8081:8081"
    build:
      context: ../../DS/ds2025_spring_example/demo-person
      dockerfile: Dockerfile
    environment:
      - DB_IP=db_user
      - DB_PORT=5432
      - DB_DBNAME=example_db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - DEVICE_SERVICE_URL=http://container-device:8080/device
    networks:
      proxy-network:

  # ==========================================
  # FRONTEND SERVICE
  # ==========================================

  frontend:
    build:
      context: ../../DS_react/react-demo/frontend
      dockerfile: Dockerfile
    container_name: frontend
    networks:
      - proxy-network
    depends_on:
      - container-person
      - container-device
    environment:
#       Tell React to talk to Traefik (localhost/api_...) not containers directly
      - REACT_APP_DEVICE_API_HOST=localhost/api_device
      - REACT_APP_PERSON_API_HOST=localhost/api_person


  # ==========================================
  # REVERSE PROXY (TRAEFIK)
  # ==========================================

  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: always
    ports:
      - "80:80"     # The Main Entrypoint (HTTP) for all users
      - "8082:8080" # Traefik Dashboard (View routes/errors)
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"  # Traefik can listen to the Docker events
      - "./traefik.yml:/etc/traefik/traefik.yml:ro"     # Static configuration file
      - "./dynamic:/etc/traefik/dynamic:ro"             # Dynamic configuration files
      - "./logs:/var/log/traefik"                       # Log files
    develop:        # Enable live reload of dynamic configuration files on Windows, if using Unix based system needs to be commented out
      watch:
       - path: ./dynamic                                # Hot-reloads config when you change files in ./dynamic
         action: restart
    networks:
      - proxy-network

  # ==========================================
  # NETWORKS & VOLUMES
  # ==========================================

# Define a shared network for all services
networks:
  proxy-network:
    driver: bridge  # Allows containers to talk to each other by name

volumes:
  db-device-data:   # Persistent storage for device DB
  db-user-data:     # Persistent storage for user DB
