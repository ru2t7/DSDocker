version: '3.9'

services:

  # ==========================================
  # MESSAGE BROKER SERVICE (NEW)
  # ==========================================

  rabbitmq:
    image: rabbitmq:3-management
    container_name: ds-rabbitmq
    hostname: ds-rabbitmq # Useful for internal connectivity
    restart: always
    environment:
      # Default user/pass for simple setup
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      # 5672: The standard port for AMQP (Advanced Message Queuing Protocol)
      - "5672:5672"
      # 15672: The port for the management web UI (accessible via http://localhost:15672)
      - "15672:15672"
    healthcheck: # ⬅️ ADD THIS BLOCK
      test: [ "CMD", "rabbitmq-diagnostics", "check_port_connectivity" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      proxy-network: # Put it on your existing network so other services can see it
    volumes:
      # Optional: Persist RabbitMQ data (queues, messages, etc.)
      - rabbitmq-data:/var/lib/rabbitmq

  # ==========================================
  # DATABASE SERVICES
  # ==========================================

  db_device:
    image: postgres
    container_name: db_device
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: example_db
    ports:
      - "5434:5432" # Access from host via localhost:5434
    volumes:
#      - db-device-data:/var/lib/postgresql/data # Persist data even if container dies
      - db-device-data:/var/lib/postgresql # Persist data even if container dies
    networks:
      proxy-network:

  db_user:
    image: postgres
    container_name: db_user
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: example_db
    ports:
      - "5433:5432" # Access from host via localhost:5433
    volumes:
#      - db-user-data:/var/lib/postgresql/data
      - db-user-data:/var/lib/postgresql
    networks:
      proxy-network:


  # ==========================================
  # BACKEND API SERVICES
  # ==========================================

  container-device:
    image: image_device
    container_name: container-device
#     Ports are commented out because Traefik handles external access internally
#     ports:
#       - "8080:8080"
    build:
      context: ../../DS/ds2025_spring_example/demo-device
      dockerfile: Dockerfile
    environment:
      - DB_IP=db_device # Must match container_name of the database above
      - DB_PORT=5432    # Internal Postgres port
      - DB_DBNAME=example_db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - PERSON_SERVICE_URL=http://container-person:8081/people
    networks:
      proxy-network:
      
  container-person:
    image: image_person
    container_name: container-person
#     Ports are commented out because Traefik handles external access internally
#    ports:
#      - "8081:8081"
    build:
      context: ../../DS/ds2025_spring_example/demo-person
      dockerfile: Dockerfile
    environment:
      - DB_IP=db_user
      - DB_PORT=5432
      - DB_DBNAME=example_db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - DEVICE_SERVICE_URL=http://container-device:8080/device
    networks:
      proxy-network:

  container-simulator: # ⬅️ NEW SERVICE
    image: image_simulator
    container_name: container-simulator
    build:
      # ⚠️ UPDATE THIS PATH to point to your new 'device-simulator' folder
      context: ../../DS/ds2025_spring_example/device-simulator
      dockerfile: Dockerfile
    environment:
      # Optional: You can pass configuration like device ID or interval here
      - DEVICE_UUIDS=277386ef-3ce3-4d2b-99b2-dc9e9766c5f8,541cb2be-6f84-49c9-afbf-481d91845343,7b7bb7e4-f33b-4906-a016-c8b69c5b4e67
      - RABBIT_HOST=ds-rabbitmq
    networks:
      proxy-network:
    # The simulator does not need to wait for other services to start, but it's good practice
    depends_on:
      rabbitmq: # ⬅️ CHANGE 'depends_on' from a list to a map
        condition: service_healthy # ⬅️ ADD THIS CONDITION

  # ==========================================
  # FRONTEND SERVICE
  # ==========================================

  frontend:
    build:
      context: "C:/Users/ruthc/IdeaProjects/DS_react/react-demo/frontend"
      dockerfile: Dockerfile
      args:
        REACT_APP_PERSON_API_HOST: http://localhost/api_person
        REACT_APP_DEVICE_API_HOST: http://localhost/api_device
    container_name: frontend
    networks:
      - proxy-network
    depends_on:
      - container-person
      - container-device

  # ==========================================
  # REVERSE PROXY (TRAEFIK)
  # ==========================================

  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: always
    ports:
      - "80:80"     # The Main Entrypoint (HTTP) for all users
      - "8082:8080" # Traefik Dashboard (View routes/errors)
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"  # Traefik can listen to the Docker events
      - "./traefik.yml:/etc/traefik/traefik.yml:ro"     # Static configuration file
      - "./dynamic:/etc/traefik/dynamic:ro"             # Dynamic configuration files
      - "./logs:/var/log/traefik"                       # Log files
    develop:        # Enable live reload of dynamic configuration files on Windows, if using Unix based system needs to be commented out
      watch:
       - path: ./dynamic                                # Hot-reloads config when you change files in ./dynamic
         action: restart
    networks:
      - proxy-network

  # ==========================================
  # NETWORKS & VOLUMES
  # ==========================================

# Define a shared network for all services
networks:
  proxy-network:
    driver: bridge  # Allows containers to talk to each other by name

volumes:
  db-device-data:   # Persistent storage for device DB
  db-user-data:     # Persistent storage for user DB
  rabbitmq-data:
